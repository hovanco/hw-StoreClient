{"ast":null,"code":"var _jsxFileName = \"/Users/mac3/Desktop/workspace/StoreClient/src/pages/setting/create-billing/state/context.tsx\",\n    _s = $RefreshSig$(),\n    _s2 = $RefreshSig$();\n\nimport { message } from 'antd';\nimport { dropWhile, maxBy, some, filter, forEach, set, keys } from 'lodash';\nimport moment from 'moment';\nimport React, { createContext, useContext, useReducer } from 'react';\nimport { useSelector } from 'react-redux';\nimport { useHistory } from 'react-router-dom';\nimport { AliasPackage, createBuyOrder, createTransactionCode, EBillingPackageType, getHistoryPayment, getPackagesActive, getPendingBilling, Packages, BillingPeriods } from '../../../../api/billing-api';\nimport { convertPackages } from '../../../../helper/convert';\nimport { checkExpiredPackage, checkWarningTrialExpiration } from '../../../../helper/get-time';\nimport { hideLoading, hideWarningExperiedPackage, hideWarningExperiedTrial, showLoading, showWarningExperiedPackage, showWarningExperiedTrial } from './action';\nimport reducer, { initialReducer } from './reducer';\nimport types from './types';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst initialContext = {\n  state: initialReducer,\n  dispatch: () => {}\n};\nconst CreateBillingContext = /*#__PURE__*/createContext(initialContext);\nconst TIME_SHOW_FOR_PACKAGE = 10;\n\nconst ProviderBillingContext = ({\n  children,\n  packagesSelect,\n  billingCycle,\n  paymentMethod,\n  reorder\n}) => {\n  _s();\n\n  const [state, dispatch] = useReducer(reducer, initialReducer);\n  return /*#__PURE__*/_jsxDEV(CreateBillingContext.Provider, {\n    value: {\n      state,\n      dispatch\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 65,\n    columnNumber: 9\n  }, this);\n};\n\n_s(ProviderBillingContext, \"VJ0NrqsrUUgLQmwbqOT1tAhbw88=\");\n\n_c = ProviderBillingContext;\n\nconst useBilling = () => {\n  _s2();\n\n  const value = useContext(CreateBillingContext);\n  const history = useHistory();\n  const storeId = useSelector(({\n    store\n  }) => store.data._id);\n  const storeCreateTime = useSelector(({\n    store\n  }) => store.data.createdAt);\n  const {\n    state,\n    dispatch\n  } = value;\n  /**\n   * init data for CreateBilling with param from url\n   * @param packagesSelectCode\n   * @param paymentMethod\n   * @param billingCycle\n   * @param reorder\n   */\n\n  const init = async (packagesSelectCode, paymentMethod, billingCycle, reorder) => {\n    try {\n      dispatch(showLoading());\n      await loadPackagesActive(false);\n      const currentPackage = state.packages.find(item => item.code === packagesSelectCode);\n      dispatch(hideLoading());\n      const initialState = {\n        paymentMethod\n      };\n\n      if (!reorder) {\n        initialState.packagesSelect = currentPackage ? [currentPackage] : [];\n        initialState.billingCycle = billingCycle || null;\n      }\n\n      dispatch({\n        type: types.INIT_STATE,\n        payload: initialState\n      });\n    } catch (error) {\n      dispatch(hideLoading());\n    }\n  };\n  /**\n   * Get list package and check experiod to show warning\n   * @param showLoad\n   */\n\n\n  const loadPackagesActive = async showLoad => {\n    var _pkgsActive$;\n\n    if (!storeId) return;\n    hideWarningExperiedTrial();\n    hideWarningExperiedPackage();\n    showLoad && dispatch(showLoading());\n    const pkgsActive = await getPackagesActive(storeId);\n    const pkgsInactive = await getPendingBilling(storeId);\n    let listName = [];\n    const listPackage = [];\n    const isExpired = (pkgsActive === null || pkgsActive === void 0 ? void 0 : pkgsActive.length) === 0;\n    const packageNamesToShow = {\n      [EBillingPackageType.Pos]: false,\n      [EBillingPackageType.Facebook]: false,\n      [EBillingPackageType.Trial]: false,\n      [EBillingPackageType.Shopee]: false,\n      [EBillingPackageType.Omni]: false\n    };\n\n    if (!isExpired) {\n      const packageTrial = pkgsActive.find(item => item.packageType === EBillingPackageType.Trial);\n      const packageAnotherTrial = dropWhile(pkgsActive, ['_id', packageTrial === null || packageTrial === void 0 ? void 0 : packageTrial._id]);\n      const packageMaxExpired = maxBy(packageAnotherTrial, function (o) {\n        return Math.round(moment(o.expiredAt).diff(moment(), 'days', true));\n      });\n      const pkgsActiveConvert = convertPackages(pkgsActive);\n      pkgsActiveConvert.forEach(item => {\n        let duration = TIME_SHOW_FOR_PACKAGE;\n        const checkExpired = checkExpiredPackage(item.expiredAt, duration);\n\n        if (checkExpired) {\n          if (item.packageType === EBillingPackageType.Trial) {\n            set(packageNamesToShow, EBillingPackageType.Trial, true);\n          }\n\n          const pkg = Packages.find(pack => item.packageType === pack.code);\n          pkg && listPackage.push(pkg);\n          set(packageNamesToShow, item.packageType, true);\n        }\n      });\n\n      if (packageMaxExpired && checkWarningTrialExpiration(packageMaxExpired === null || packageMaxExpired === void 0 ? void 0 : packageMaxExpired.expiredAt)) {\n        dispatch(showWarningExperiedPackage());\n      } else if (packageTrial && packageTrial.packageType === EBillingPackageType.Trial && checkWarningTrialExpiration(packageTrial.expiredAt)) {\n        dispatch(showWarningExperiedTrial());\n      }\n    } else {\n      if (!storeId) return;\n      const listPayment = await getHistoryPayment(storeId);\n      const isTrial = some(listPayment, {\n        packageType: EBillingPackageType.Trial\n      });\n\n      if (isTrial) {\n        dispatch(showWarningExperiedTrial());\n      } else {\n        const currentActivePackage = convertPackages(filter(listPayment, {\n          active: true\n        }));\n        forEach(currentActivePackage, item => {\n          const pkg = Packages.find(pack => item.packageType === pack.code);\n          pkg && listPackage.push(pkg);\n          set(packageNamesToShow, item.packageType, true);\n        });\n        dispatch(showWarningExperiedPackage());\n      }\n    }\n\n    forEach(keys(packageNamesToShow), type => {\n      if (packageNamesToShow[Number(type)]) {\n        listName = [...listName, AliasPackage[Number(type)]];\n      }\n    });\n    dispatch({\n      type: types.CHANGE_VALUE_FIELD,\n      payload: {\n        field: 'billingCycle',\n        value: (pkgsActive === null || pkgsActive === void 0 ? void 0 : (_pkgsActive$ = pkgsActive[0]) === null || _pkgsActive$ === void 0 ? void 0 : _pkgsActive$.period) || BillingPeriods.SixMonths\n      }\n    });\n    dispatch({\n      type: types.UPDATE_PACKAGES,\n      payload: listPackage\n    });\n    dispatch({\n      type: types.SET_PACKAGES_NEED_EXTENED,\n      payload: listPackage\n    });\n    dispatch({\n      type: types.SET_NAME_PACKAGES_EXPERIED,\n      payload: listName\n    });\n    dispatch({\n      type: types.GET_PACKAGES_ACTIVE,\n      payload: pkgsActive\n    });\n    dispatch({\n      type: types.GET_PACKAGES_INACTIVE,\n      payload: pkgsInactive\n    });\n    dispatch({\n      type: types.GET_ALL_PACKAGES,\n      payload: pkgsActive\n    });\n    await getListHistoryPayment();\n  };\n  /**\n   * update data for package selected\n   * @param data\n   */\n\n\n  const updatePackages = data => {\n    dispatch({\n      type: types.UPDATE_PACKAGES,\n      payload: data\n    });\n  };\n\n  const changeValueField = data => {\n    dispatch({\n      type: types.CHANGE_VALUE_FIELD,\n      payload: data\n    });\n  };\n\n  const changeCycleForPackage = data => {\n    dispatch({\n      type: types.CHANGE_CYCLE_FIELD,\n      payload: data\n    });\n  };\n\n  const initOrderState = data => {\n    dispatch({\n      type: types.INIT_STATE,\n      payload: data\n    });\n  };\n\n  const resetListNeedExtend = () => {\n    dispatch({\n      type: types.SET_PACKAGES_NEED_EXTENED,\n      payload: []\n    });\n  };\n\n  const getListHistoryPayment = async () => {\n    if (!storeId) return;\n    const listPayment = await getHistoryPayment(storeId);\n    dispatch({\n      type: types.GET_HISTORY_PAYMENT,\n      payload: listPayment\n    });\n  };\n  /**\n   * buy package\n   */\n\n\n  const createPayment = async () => {\n    try {\n      if (!storeId) return;\n      const transactionCode = await createTransactionCode(storeId, null);\n      const data = {\n        paymentType: state.paymentMethod,\n        period: state.billingCycle,\n        transactionCode,\n        packageType: state.packagesSelect.reduce((prevValue, item) => prevValue + item.code, 0)\n      };\n      await createBuyOrder(storeId, data);\n      message.success('Mua gói thành công');\n      await loadPackagesActive(false);\n      history.replace('/setting/billings/list');\n    } catch (error) {\n      message.error('Đã có lỗi xảy ra');\n    }\n  };\n\n  const genTransationCode = async () => {\n    try {\n      if (!storeId) return;\n      const transactionCode = await createTransactionCode(storeId, null);\n      setTransactionCode(transactionCode);\n    } catch (error) {\n      setTransactionCode();\n      message.error('Đã có lỗi xảy ra');\n    }\n  };\n\n  const setTransactionCode = (code = '') => {\n    dispatch({\n      type: types.SET_TRANSACTION_CODE,\n      payload: code\n    });\n  };\n\n  const resetTransactionCode = () => setTransactionCode();\n\n  const closeWaringExperiedPackage = () => dispatch(hideWarningExperiedPackage());\n\n  const closeWaringExperiedTrail = () => dispatch(hideWarningExperiedTrial());\n\n  return { ...state,\n    changeValueField,\n    initOrderState,\n    updatePackages,\n    changeCycleForPackage,\n    createPayment,\n    closeWaringExperiedPackage,\n    closeWaringExperiedTrail,\n    init,\n    loadPackagesActive,\n    genTransationCode,\n    resetTransactionCode,\n    resetListNeedExtend\n  };\n};\n\n_s2(useBilling, \"6irHUy6lI49pey+smi2k+ycZahs=\", false, function () {\n  return [useHistory, useSelector, useSelector];\n});\n\nexport { ProviderBillingContext as default, useBilling };\n\nvar _c;\n\n$RefreshReg$(_c, \"ProviderBillingContext\");","map":{"version":3,"sources":["/Users/mac3/Desktop/workspace/StoreClient/src/pages/setting/create-billing/state/context.tsx"],"names":["message","dropWhile","maxBy","some","filter","forEach","set","keys","moment","React","createContext","useContext","useReducer","useSelector","useHistory","AliasPackage","createBuyOrder","createTransactionCode","EBillingPackageType","getHistoryPayment","getPackagesActive","getPendingBilling","Packages","BillingPeriods","convertPackages","checkExpiredPackage","checkWarningTrialExpiration","hideLoading","hideWarningExperiedPackage","hideWarningExperiedTrial","showLoading","showWarningExperiedPackage","showWarningExperiedTrial","reducer","initialReducer","types","initialContext","state","dispatch","CreateBillingContext","TIME_SHOW_FOR_PACKAGE","ProviderBillingContext","children","packagesSelect","billingCycle","paymentMethod","reorder","useBilling","value","history","storeId","store","data","_id","storeCreateTime","createdAt","init","packagesSelectCode","loadPackagesActive","currentPackage","packages","find","item","code","initialState","type","INIT_STATE","payload","error","showLoad","pkgsActive","pkgsInactive","listName","listPackage","isExpired","length","packageNamesToShow","Pos","Facebook","Trial","Shopee","Omni","packageTrial","packageType","packageAnotherTrial","packageMaxExpired","o","Math","round","expiredAt","diff","pkgsActiveConvert","duration","checkExpired","pkg","pack","push","listPayment","isTrial","currentActivePackage","active","Number","CHANGE_VALUE_FIELD","field","period","SixMonths","UPDATE_PACKAGES","SET_PACKAGES_NEED_EXTENED","SET_NAME_PACKAGES_EXPERIED","GET_PACKAGES_ACTIVE","GET_PACKAGES_INACTIVE","GET_ALL_PACKAGES","getListHistoryPayment","updatePackages","changeValueField","changeCycleForPackage","CHANGE_CYCLE_FIELD","initOrderState","resetListNeedExtend","GET_HISTORY_PAYMENT","createPayment","transactionCode","paymentType","reduce","prevValue","success","replace","genTransationCode","setTransactionCode","SET_TRANSACTION_CODE","resetTransactionCode","closeWaringExperiedPackage","closeWaringExperiedTrail","default"],"mappings":"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","sourcesContent":["import { message } from 'antd';\nimport { dropWhile, maxBy, some, filter, forEach, set, keys, map } from 'lodash';\nimport moment from 'moment';\nimport React, { createContext, FC, ReactNode, useContext, useReducer } from 'react';\nimport { useSelector } from 'react-redux';\nimport { useHistory } from 'react-router-dom';\nimport {\n    AliasPackage,\n    createBuyOrder,\n    createTransactionCode,\n    EBillingPackageType,\n    FormBuy,\n    getHistoryPayment,\n    getPackagesActive,\n    getPendingBilling,\n    Packages,\n    BillingPeriods,\n} from '../../../../api/billing-api';\nimport { convertPackages } from '../../../../helper/convert';\nimport {\n    checkExpiredPackage,\n    checkExpiredTrialForLegacyStore,\n    checkWarningTrialExpiration,\n} from '../../../../helper/get-time';\nimport { IStoreState } from '../../../../reducers/storeState/reducer';\nimport { IPackageBiling } from '../../list-billings/package-biling';\nimport {\n    hideLoading,\n    hideWarningExperiedPackage,\n    hideWarningExperiedTrial,\n    showLoading,\n    showWarningExperiedPackage,\n    showWarningExperiedTrial,\n} from './action';\nimport { IContext, IPackage } from './interface';\nimport reducer, { initialReducer } from './reducer';\nimport types from './types';\n\nconst initialContext = {\n    state: initialReducer,\n    dispatch: () => {},\n};\n\nconst CreateBillingContext = createContext<IContext>(initialContext);\n\nconst TIME_SHOW_FOR_PACKAGE = 10;\n\ninterface Props {\n    children: ReactNode;\n    packagesSelect?: string;\n    billingCycle?: string;\n    paymentMethod?: number;\n    reorder?: boolean;\n}\n\nconst ProviderBillingContext: FC<Props> = ({\n    children,\n    packagesSelect,\n    billingCycle,\n    paymentMethod,\n    reorder,\n}) => {\n    const [state, dispatch] = useReducer(reducer, initialReducer);\n    return (\n        <CreateBillingContext.Provider value={{ state, dispatch }}>\n            {children}\n        </CreateBillingContext.Provider>\n    );\n};\n\nconst useBilling = () => {\n    const value = useContext(CreateBillingContext);\n    const history = useHistory();\n\n    const storeId = useSelector(({ store }: { store: IStoreState }) => store.data._id);\n    const storeCreateTime = useSelector(\n        ({ store }: { store: IStoreState }) => store.data.createdAt,\n    );\n\n    const { state, dispatch } = value;\n    /**\n     * init data for CreateBilling with param from url\n     * @param packagesSelectCode\n     * @param paymentMethod\n     * @param billingCycle\n     * @param reorder\n     */\n    const init = async (\n        packagesSelectCode: number,\n        paymentMethod: number,\n        billingCycle: number,\n        reorder: boolean,\n    ) => {\n        try {\n            dispatch(showLoading());\n            await loadPackagesActive(false);\n            const currentPackage = state.packages.find(\n                (item: IPackageBiling) => item.code === packagesSelectCode,\n            );\n            dispatch(hideLoading());\n            const initialState: any = {\n                paymentMethod,\n            };\n            if (!reorder) {\n                initialState.packagesSelect = currentPackage ? [currentPackage] : [];\n                initialState.billingCycle = billingCycle || null;\n            }\n            dispatch({\n                type: types.INIT_STATE,\n                payload: initialState,\n            });\n        } catch (error) {\n            dispatch(hideLoading());\n        }\n    };\n    /**\n     * Get list package and check experiod to show warning\n     * @param showLoad\n     */\n    const loadPackagesActive = async (showLoad: boolean) => {\n        if (!storeId) return;\n        hideWarningExperiedTrial();\n        hideWarningExperiedPackage();\n        showLoad && dispatch(showLoading());\n        const pkgsActive: IPackage[] = await getPackagesActive(storeId);\n        const pkgsInactive: IPackage[] = await getPendingBilling(storeId);\n        let listName: string[] = [];\n        const listPackage: IPackageBiling[] = [];\n        const isExpired = pkgsActive?.length === 0;\n\n        const packageNamesToShow = {\n            [EBillingPackageType.Pos]: false,\n            [EBillingPackageType.Facebook]: false,\n            [EBillingPackageType.Trial]: false,\n            [EBillingPackageType.Shopee]: false,\n            [EBillingPackageType.Omni]: false,\n        }\n\n        if (!isExpired) {\n\n            const packageTrial = pkgsActive.find(\n                (item) => item.packageType === EBillingPackageType.Trial,\n            );\n\n            const packageAnotherTrial = dropWhile(pkgsActive, ['_id', packageTrial?._id]);\n            const packageMaxExpired: IPackage = maxBy(packageAnotherTrial, function (o) {\n                return Math.round(moment(o.expiredAt).diff(moment(), 'days', true));\n            });\n\n            const pkgsActiveConvert = convertPackages(pkgsActive);\n            pkgsActiveConvert.forEach((item: IPackage) => {\n                let duration = TIME_SHOW_FOR_PACKAGE;\n                const checkExpired = checkExpiredPackage(item.expiredAt, duration);\n                if (checkExpired) {\n                    if (item.packageType === EBillingPackageType.Trial) {\n                        set(packageNamesToShow, EBillingPackageType.Trial, true);\n                    }\n                    const pkg = Packages.find((pack: IPackageBiling) => item.packageType === pack.code);\n                    pkg && listPackage.push(pkg);\n                    set(packageNamesToShow, item.packageType, true);\n                }\n            });\n\n            if (packageMaxExpired && checkWarningTrialExpiration(packageMaxExpired?.expiredAt)) {\n                dispatch(showWarningExperiedPackage());\n            } else if (\n                packageTrial &&\n                packageTrial.packageType === EBillingPackageType.Trial &&\n                checkWarningTrialExpiration(packageTrial.expiredAt)\n            ) {\n                dispatch(showWarningExperiedTrial());\n            }\n        } else {\n            if (!storeId) return;\n            const listPayment: IPackage[] = await getHistoryPayment(storeId);\n            const isTrial = some(listPayment, { packageType: EBillingPackageType.Trial });\n\n            if (isTrial) {\n                dispatch(showWarningExperiedTrial());\n            } else {\n                const currentActivePackage = convertPackages(filter(listPayment, { active: true }));\n                forEach(currentActivePackage, (item) => {\n                    const pkg = Packages.find((pack: IPackageBiling) => item.packageType === pack.code);\n                    pkg && listPackage.push(pkg);\n                    set(packageNamesToShow, item.packageType, true);\n                })\n                dispatch(showWarningExperiedPackage());\n            }\n        }\n\n        forEach(keys(packageNamesToShow), (type: string) => {\n            if (packageNamesToShow[Number(type)]) {\n                listName = [...listName, AliasPackage[Number(type)]];\n            }\n        });\n\n        dispatch({\n            type: types.CHANGE_VALUE_FIELD,\n            payload: {\n                field: 'billingCycle',\n                value: pkgsActive?.[0]?.period || BillingPeriods.SixMonths,\n            },\n        });\n        dispatch({\n            type: types.UPDATE_PACKAGES,\n            payload: listPackage,\n        });\n        dispatch({\n            type: types.SET_PACKAGES_NEED_EXTENED,\n            payload: listPackage,\n        });\n        dispatch({\n            type: types.SET_NAME_PACKAGES_EXPERIED,\n            payload: listName,\n        });\n        dispatch({\n            type: types.GET_PACKAGES_ACTIVE,\n            payload: pkgsActive,\n        });\n        dispatch({\n            type: types.GET_PACKAGES_INACTIVE,\n            payload: pkgsInactive,\n        });\n        dispatch({\n            type: types.GET_ALL_PACKAGES,\n            payload: pkgsActive,\n        });\n        await getListHistoryPayment();\n    };\n    /**\n     * update data for package selected\n     * @param data\n     */\n    const updatePackages = (data: any) => {\n        dispatch({\n            type: types.UPDATE_PACKAGES,\n            payload: data,\n        });\n    };\n\n    const changeValueField = (data: { field: string; value: any }) => {\n        dispatch({\n            type: types.CHANGE_VALUE_FIELD,\n            payload: data,\n        });\n    };\n\n    const changeCycleForPackage = (data: number) => {\n        dispatch({\n            type: types.CHANGE_CYCLE_FIELD,\n            payload: data,\n        });\n    };\n\n    const initOrderState = (data: any) => {\n        dispatch({\n            type: types.INIT_STATE,\n            payload: data,\n        });\n    };\n\n    const resetListNeedExtend = () => {\n        dispatch({\n            type: types.SET_PACKAGES_NEED_EXTENED,\n            payload: [],\n        });\n    };\n\n    const getListHistoryPayment = async () => {\n        if (!storeId) return;\n        const listPayment = await getHistoryPayment(storeId);\n        dispatch({\n            type: types.GET_HISTORY_PAYMENT,\n            payload: listPayment,\n        });\n    };\n\n    /**\n     * buy package\n     */\n    const createPayment = async () => {\n        try {\n            if (!storeId) return;\n            const transactionCode = await createTransactionCode(storeId, null);\n            const data: FormBuy = {\n                paymentType: state.paymentMethod,\n                period: state.billingCycle,\n                transactionCode,\n                packageType: state.packagesSelect.reduce(\n                    (prevValue: number, item: IPackageBiling) => prevValue + item.code,\n                    0,\n                ),\n            };\n            await createBuyOrder(storeId, data);\n            message.success('Mua gói thành công');\n            await loadPackagesActive(false);\n            history.replace('/setting/billings/list');\n        } catch (error) {\n            message.error('Đã có lỗi xảy ra');\n        }\n    };\n\n    const genTransationCode = async () => {\n        try {\n            if (!storeId) return;\n            const transactionCode = await createTransactionCode(storeId, null);\n            setTransactionCode(transactionCode);\n        } catch (error) {\n            setTransactionCode();\n            message.error('Đã có lỗi xảy ra');\n        }\n    };\n\n    const setTransactionCode = (code: string = '') => {\n        dispatch({\n            type: types.SET_TRANSACTION_CODE,\n            payload: code,\n        });\n    };\n\n    const resetTransactionCode = () => setTransactionCode();\n\n    const closeWaringExperiedPackage = () => dispatch(hideWarningExperiedPackage());\n    const closeWaringExperiedTrail = () => dispatch(hideWarningExperiedTrial());\n\n    return {\n        ...state,\n        changeValueField,\n        initOrderState,\n        updatePackages,\n        changeCycleForPackage,\n        createPayment,\n        closeWaringExperiedPackage,\n        closeWaringExperiedTrail,\n        init,\n        loadPackagesActive,\n        genTransationCode,\n        resetTransactionCode,\n        resetListNeedExtend,\n    };\n};\n\nexport { ProviderBillingContext as default, useBilling };\n"]},"metadata":{},"sourceType":"module"}