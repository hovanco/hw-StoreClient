{"ast":null,"code":"var _jsxFileName = \"/Users/mac3/Desktop/workspace/StoreClient/src/pages/setting/create-billing/state/context.tsx\",\n    _s = $RefreshSig$(),\n    _s2 = $RefreshSig$();\n\nimport { message } from 'antd';\nimport { dropWhile, maxBy } from 'lodash';\nimport moment from 'moment';\nimport React, { createContext, useContext, useReducer } from 'react';\nimport { useSelector } from 'react-redux';\nimport { useHistory } from 'react-router-dom';\nimport { AliasPackage, createBuyOrder, createTransactionCode, EBillingPackageType, getHistoryPayment, getPackagesActive, getPendingBilling, Packages, BillingPeriods } from '../../../../api/billing-api';\nimport { convertPackages } from '../../../../helper/convert';\nimport { checkExpiredPackage, checkWarningTrialExpiration } from '../../../../helper/get-time';\nimport { hideLoading, hideWarningExperiedPackage, hideWarningExperiedTrial, showLoading, showWarningExperiedPackage, showWarningExperiedTrial } from './action';\nimport reducer, { initialReducer } from './reducer';\nimport types from './types';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst initialContext = {\n  state: initialReducer,\n  dispatch: () => {}\n};\nconst CreateBillingContext = /*#__PURE__*/createContext(initialContext);\nconst TIME_SHOW_FOR_PACKAGE = 10;\n\nconst ProviderBillingContext = ({\n  children,\n  packagesSelect,\n  billingCycle,\n  paymentMethod,\n  reorder\n}) => {\n  _s();\n\n  const [state, dispatch] = useReducer(reducer, initialReducer);\n  return /*#__PURE__*/_jsxDEV(CreateBillingContext.Provider, {\n    value: {\n      state,\n      dispatch\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 65,\n    columnNumber: 9\n  }, this);\n};\n\n_s(ProviderBillingContext, \"VJ0NrqsrUUgLQmwbqOT1tAhbw88=\");\n\n_c = ProviderBillingContext;\n\nconst useBilling = () => {\n  _s2();\n\n  const value = useContext(CreateBillingContext);\n  const history = useHistory();\n  const storeId = useSelector(({\n    store\n  }) => store.data._id);\n  const storeCreateTime = useSelector(({\n    store\n  }) => store.data.createdAt);\n  const {\n    state,\n    dispatch\n  } = value;\n  /**\n   * init data for CreateBilling with param from url\n   * @param packagesSelectCode\n   * @param paymentMethod\n   * @param billingCycle\n   * @param reorder\n   */\n\n  const init = async (packagesSelectCode, paymentMethod, billingCycle, reorder) => {\n    try {\n      dispatch(showLoading());\n      await loadPackagesActive(false);\n      const currentPackage = state.packages.find(item => item.code === packagesSelectCode);\n      dispatch(hideLoading());\n      const initialState = {\n        paymentMethod\n      };\n\n      if (!reorder) {\n        initialState.packagesSelect = currentPackage ? [currentPackage] : [];\n        initialState.billingCycle = billingCycle || null;\n      }\n\n      dispatch({\n        type: types.INIT_STATE,\n        payload: initialState\n      });\n    } catch (error) {\n      dispatch(hideLoading());\n    }\n  };\n  /**\n   * Get list package and check experiod to show warning\n   * @param showLoad\n   */\n\n\n  const loadPackagesActive = async showLoad => {\n    var _pkgsActive$;\n\n    if (!storeId) return;\n    hideWarningExperiedTrial();\n    hideWarningExperiedPackage();\n    showLoad && dispatch(showLoading());\n    const pkgsActive = await getPackagesActive(storeId);\n    const pkgsInactive = await getPendingBilling(storeId);\n    const listName = [];\n    const listPackage = [];\n    if ((pkgsActive === null || pkgsActive === void 0 ? void 0 : pkgsActive.length) === 0) dispatch(showWarningExperiedTrial());\n    const packageTrial = pkgsActive.find(item => item.packageType === EBillingPackageType.Trial);\n    const packageAnotherTrial = dropWhile(pkgsActive, ['_id', packageTrial === null || packageTrial === void 0 ? void 0 : packageTrial._id]);\n    const packageMaxExpired = maxBy(packageAnotherTrial, function (o) {\n      return Math.round(moment(o.expiredAt).diff(moment(), 'days', true));\n    });\n    const pkgsActiveConvert = convertPackages(pkgsActive);\n    pkgsActiveConvert.forEach(item => {\n      let duration = TIME_SHOW_FOR_PACKAGE;\n      const checkExpired = checkExpiredPackage(item.expiredAt, duration);\n\n      if (checkExpired) {\n        if (item.packageType === EBillingPackageType.Trial) {\n          listName.push(AliasPackage[EBillingPackageType.Trial]);\n        }\n\n        const pkg = Packages.find(pack => item.packageType === pack.code);\n        pkg && listPackage.push(pkg);\n        listName.push(AliasPackage[item.packageType]);\n      }\n    });\n\n    if (packageMaxExpired && checkWarningTrialExpiration(packageMaxExpired === null || packageMaxExpired === void 0 ? void 0 : packageMaxExpired.expiredAt)) {\n      dispatch(showWarningExperiedPackage());\n    } else if (packageTrial && packageTrial.packageType === EBillingPackageType.Trial && checkWarningTrialExpiration(packageTrial.expiredAt)) {\n      dispatch(showWarningExperiedTrial());\n    }\n\n    dispatch({\n      type: types.CHANGE_VALUE_FIELD,\n      payload: {\n        field: 'billingCycle',\n        value: (pkgsActive === null || pkgsActive === void 0 ? void 0 : (_pkgsActive$ = pkgsActive[0]) === null || _pkgsActive$ === void 0 ? void 0 : _pkgsActive$.period) || BillingPeriods.SixMonths\n      }\n    });\n    dispatch({\n      type: types.UPDATE_PACKAGES,\n      payload: listPackage\n    });\n    dispatch({\n      type: types.SET_PACKAGES_NEED_EXTENED,\n      payload: listPackage\n    });\n    dispatch({\n      type: types.SET_NAME_PACKAGES_EXPERIED,\n      payload: listName\n    });\n    dispatch({\n      type: types.GET_PACKAGES_ACTIVE,\n      payload: pkgsActive\n    });\n    dispatch({\n      type: types.GET_PACKAGES_INACTIVE,\n      payload: pkgsInactive\n    });\n    dispatch({\n      type: types.GET_ALL_PACKAGES,\n      payload: pkgsActive\n    });\n    await getListHistoryPayment();\n  };\n  /**\n   * update data for package selected\n   * @param data\n   */\n\n\n  const updatePackages = data => {\n    dispatch({\n      type: types.UPDATE_PACKAGES,\n      payload: data\n    });\n  };\n\n  const changeValueField = data => {\n    dispatch({\n      type: types.CHANGE_VALUE_FIELD,\n      payload: data\n    });\n  };\n\n  const changeCycleForPackage = data => {\n    dispatch({\n      type: types.CHANGE_CYCLE_FIELD,\n      payload: data\n    });\n  };\n\n  const initOrderState = data => {\n    dispatch({\n      type: types.INIT_STATE,\n      payload: data\n    });\n  };\n\n  const resetListNeedExtend = () => {\n    dispatch({\n      type: types.SET_PACKAGES_NEED_EXTENED,\n      payload: []\n    });\n  };\n\n  const getListHistoryPayment = async () => {\n    if (!storeId) return;\n    const listPayment = await getHistoryPayment(storeId);\n    dispatch({\n      type: types.GET_HISTORY_PAYMENT,\n      payload: listPayment\n    });\n  };\n  /**\n   * buy package\n   */\n\n\n  const createPayment = async () => {\n    try {\n      if (!storeId) return;\n      const transactionCode = await createTransactionCode(storeId, null);\n      const data = {\n        paymentType: state.paymentMethod,\n        period: state.billingCycle,\n        transactionCode,\n        packageType: state.packagesSelect.reduce((prevValue, item) => prevValue + item.code, 0)\n      };\n      await createBuyOrder(storeId, data);\n      message.success('Mua gói thành công');\n      await loadPackagesActive(false);\n      history.replace('/setting/billings/list');\n    } catch (error) {\n      message.error('Đã có lỗi xảy ra');\n    }\n  };\n\n  const genTransationCode = async () => {\n    try {\n      if (!storeId) return;\n      const transactionCode = await createTransactionCode(storeId, null);\n      setTransactionCode(transactionCode);\n    } catch (error) {\n      setTransactionCode();\n      message.error('Đã có lỗi xảy ra');\n    }\n  };\n\n  const setTransactionCode = (code = '') => {\n    dispatch({\n      type: types.SET_TRANSACTION_CODE,\n      payload: code\n    });\n  };\n\n  const resetTransactionCode = () => setTransactionCode();\n\n  const closeWaringExperiedPackage = () => dispatch(hideWarningExperiedPackage());\n\n  const closeWaringExperiedTrail = () => dispatch(hideWarningExperiedTrial());\n\n  return { ...state,\n    changeValueField,\n    initOrderState,\n    updatePackages,\n    changeCycleForPackage,\n    createPayment,\n    closeWaringExperiedPackage,\n    closeWaringExperiedTrail,\n    init,\n    loadPackagesActive,\n    genTransationCode,\n    resetTransactionCode,\n    resetListNeedExtend\n  };\n};\n\n_s2(useBilling, \"6irHUy6lI49pey+smi2k+ycZahs=\", false, function () {\n  return [useHistory, useSelector, useSelector];\n});\n\nexport { ProviderBillingContext as default, useBilling };\n\nvar _c;\n\n$RefreshReg$(_c, \"ProviderBillingContext\");","map":{"version":3,"sources":["/Users/mac3/Desktop/workspace/StoreClient/src/pages/setting/create-billing/state/context.tsx"],"names":["message","dropWhile","maxBy","moment","React","createContext","useContext","useReducer","useSelector","useHistory","AliasPackage","createBuyOrder","createTransactionCode","EBillingPackageType","getHistoryPayment","getPackagesActive","getPendingBilling","Packages","BillingPeriods","convertPackages","checkExpiredPackage","checkWarningTrialExpiration","hideLoading","hideWarningExperiedPackage","hideWarningExperiedTrial","showLoading","showWarningExperiedPackage","showWarningExperiedTrial","reducer","initialReducer","types","initialContext","state","dispatch","CreateBillingContext","TIME_SHOW_FOR_PACKAGE","ProviderBillingContext","children","packagesSelect","billingCycle","paymentMethod","reorder","useBilling","value","history","storeId","store","data","_id","storeCreateTime","createdAt","init","packagesSelectCode","loadPackagesActive","currentPackage","packages","find","item","code","initialState","type","INIT_STATE","payload","error","showLoad","pkgsActive","pkgsInactive","listName","listPackage","length","packageTrial","packageType","Trial","packageAnotherTrial","packageMaxExpired","o","Math","round","expiredAt","diff","pkgsActiveConvert","forEach","duration","checkExpired","push","pkg","pack","CHANGE_VALUE_FIELD","field","period","SixMonths","UPDATE_PACKAGES","SET_PACKAGES_NEED_EXTENED","SET_NAME_PACKAGES_EXPERIED","GET_PACKAGES_ACTIVE","GET_PACKAGES_INACTIVE","GET_ALL_PACKAGES","getListHistoryPayment","updatePackages","changeValueField","changeCycleForPackage","CHANGE_CYCLE_FIELD","initOrderState","resetListNeedExtend","listPayment","GET_HISTORY_PAYMENT","createPayment","transactionCode","paymentType","reduce","prevValue","success","replace","genTransationCode","setTransactionCode","SET_TRANSACTION_CODE","resetTransactionCode","closeWaringExperiedPackage","closeWaringExperiedTrail","default"],"mappings":"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","sourcesContent":["import { message } from 'antd';\nimport { dropWhile, maxBy } from 'lodash';\nimport moment from 'moment';\nimport React, { createContext, FC, ReactNode, useContext, useReducer } from 'react';\nimport { useSelector } from 'react-redux';\nimport { useHistory } from 'react-router-dom';\nimport {\n    AliasPackage,\n    createBuyOrder,\n    createTransactionCode,\n    EBillingPackageType,\n    FormBuy,\n    getHistoryPayment,\n    getPackagesActive,\n    getPendingBilling,\n    Packages,\n    BillingPeriods,\n} from '../../../../api/billing-api';\nimport { convertPackages } from '../../../../helper/convert';\nimport {\n    checkExpiredPackage,\n    checkExpiredTrialForLegacyStore,\n    checkWarningTrialExpiration,\n} from '../../../../helper/get-time';\nimport { IStoreState } from '../../../../reducers/storeState/reducer';\nimport { IPackageBiling } from '../../list-billings/package-biling';\nimport {\n    hideLoading,\n    hideWarningExperiedPackage,\n    hideWarningExperiedTrial,\n    showLoading,\n    showWarningExperiedPackage,\n    showWarningExperiedTrial,\n} from './action';\nimport { IContext, IPackage } from './interface';\nimport reducer, { initialReducer } from './reducer';\nimport types from './types';\n\nconst initialContext = {\n    state: initialReducer,\n    dispatch: () => {},\n};\n\nconst CreateBillingContext = createContext<IContext>(initialContext);\n\nconst TIME_SHOW_FOR_PACKAGE = 10;\n\ninterface Props {\n    children: ReactNode;\n    packagesSelect?: string;\n    billingCycle?: string;\n    paymentMethod?: number;\n    reorder?: boolean;\n}\n\nconst ProviderBillingContext: FC<Props> = ({\n    children,\n    packagesSelect,\n    billingCycle,\n    paymentMethod,\n    reorder,\n}) => {\n    const [state, dispatch] = useReducer(reducer, initialReducer);\n    return (\n        <CreateBillingContext.Provider value={{ state, dispatch }}>\n            {children}\n        </CreateBillingContext.Provider>\n    );\n};\n\nconst useBilling = () => {\n    const value = useContext(CreateBillingContext);\n    const history = useHistory();\n\n    const storeId = useSelector(({ store }: { store: IStoreState }) => store.data._id);\n    const storeCreateTime = useSelector(\n        ({ store }: { store: IStoreState }) => store.data.createdAt,\n    );\n\n    const { state, dispatch } = value;\n    /**\n     * init data for CreateBilling with param from url\n     * @param packagesSelectCode\n     * @param paymentMethod\n     * @param billingCycle\n     * @param reorder\n     */\n    const init = async (\n        packagesSelectCode: number,\n        paymentMethod: number,\n        billingCycle: number,\n        reorder: boolean,\n    ) => {\n        try {\n            dispatch(showLoading());\n            await loadPackagesActive(false);\n            const currentPackage = state.packages.find(\n                (item: IPackageBiling) => item.code === packagesSelectCode,\n            );\n            dispatch(hideLoading());\n            const initialState: any = {\n                paymentMethod,\n            };\n            if (!reorder) {\n                initialState.packagesSelect = currentPackage ? [currentPackage] : [];\n                initialState.billingCycle = billingCycle || null;\n            }\n            dispatch({\n                type: types.INIT_STATE,\n                payload: initialState,\n            });\n        } catch (error) {\n            dispatch(hideLoading());\n        }\n    };\n    /**\n     * Get list package and check experiod to show warning\n     * @param showLoad\n     */\n    const loadPackagesActive = async (showLoad: boolean) => {\n        if (!storeId) return;\n        hideWarningExperiedTrial();\n        hideWarningExperiedPackage();\n        showLoad && dispatch(showLoading());\n        const pkgsActive: IPackage[] = await getPackagesActive(storeId);\n        const pkgsInactive: IPackage[] = await getPendingBilling(storeId);\n        const listName: string[] = [];\n        const listPackage: IPackageBiling[] = [];\n        if (pkgsActive?.length === 0) dispatch(showWarningExperiedTrial());\n\n        const packageTrial = pkgsActive.find(\n            (item) => item.packageType === EBillingPackageType.Trial,\n        );\n\n        const packageAnotherTrial = dropWhile(pkgsActive, ['_id', packageTrial?._id]);\n        const packageMaxExpired: IPackage = maxBy(packageAnotherTrial, function (o) {\n            return Math.round(moment(o.expiredAt).diff(moment(), 'days', true));\n        });\n\n        const pkgsActiveConvert = convertPackages(pkgsActive);\n        pkgsActiveConvert.forEach((item: IPackage) => {\n            let duration = TIME_SHOW_FOR_PACKAGE;\n            const checkExpired = checkExpiredPackage(item.expiredAt, duration);\n            if (checkExpired) {\n                if (item.packageType === EBillingPackageType.Trial) {\n                    listName.push(AliasPackage[EBillingPackageType.Trial]);\n                }\n                const pkg = Packages.find((pack: IPackageBiling) => item.packageType === pack.code);\n                pkg && listPackage.push(pkg);\n                listName.push(AliasPackage[item.packageType]);\n            }\n        });\n\n        if (packageMaxExpired && checkWarningTrialExpiration(packageMaxExpired?.expiredAt)) {\n            dispatch(showWarningExperiedPackage());\n        } else if (\n            packageTrial &&\n            packageTrial.packageType === EBillingPackageType.Trial &&\n            checkWarningTrialExpiration(packageTrial.expiredAt)\n        ) {\n            dispatch(showWarningExperiedTrial());\n        }\n\n        dispatch({\n            type: types.CHANGE_VALUE_FIELD,\n            payload: {\n                field: 'billingCycle',\n                value: pkgsActive?.[0]?.period || BillingPeriods.SixMonths,\n            },\n        });\n        dispatch({\n            type: types.UPDATE_PACKAGES,\n            payload: listPackage,\n        });\n        dispatch({\n            type: types.SET_PACKAGES_NEED_EXTENED,\n            payload: listPackage,\n        });\n        dispatch({\n            type: types.SET_NAME_PACKAGES_EXPERIED,\n            payload: listName,\n        });\n        dispatch({\n            type: types.GET_PACKAGES_ACTIVE,\n            payload: pkgsActive,\n        });\n        dispatch({\n            type: types.GET_PACKAGES_INACTIVE,\n            payload: pkgsInactive,\n        });\n        dispatch({\n            type: types.GET_ALL_PACKAGES,\n            payload: pkgsActive,\n        });\n        await getListHistoryPayment();\n    };\n    /**\n     * update data for package selected\n     * @param data\n     */\n    const updatePackages = (data: any) => {\n        dispatch({\n            type: types.UPDATE_PACKAGES,\n            payload: data,\n        });\n    };\n\n    const changeValueField = (data: { field: string; value: any }) => {\n        dispatch({\n            type: types.CHANGE_VALUE_FIELD,\n            payload: data,\n        });\n    };\n\n    const changeCycleForPackage = (data: number) => {\n        dispatch({\n            type: types.CHANGE_CYCLE_FIELD,\n            payload: data,\n        });\n    };\n\n    const initOrderState = (data: any) => {\n        dispatch({\n            type: types.INIT_STATE,\n            payload: data,\n        });\n    };\n\n    const resetListNeedExtend = () => {\n        dispatch({\n            type: types.SET_PACKAGES_NEED_EXTENED,\n            payload: [],\n        });\n    };\n\n    const getListHistoryPayment = async () => {\n        if (!storeId) return;\n        const listPayment = await getHistoryPayment(storeId);\n        dispatch({\n            type: types.GET_HISTORY_PAYMENT,\n            payload: listPayment,\n        });\n    };\n\n    /**\n     * buy package\n     */\n    const createPayment = async () => {\n        try {\n            if (!storeId) return;\n            const transactionCode = await createTransactionCode(storeId, null);\n            const data: FormBuy = {\n                paymentType: state.paymentMethod,\n                period: state.billingCycle,\n                transactionCode,\n                packageType: state.packagesSelect.reduce(\n                    (prevValue: number, item: IPackageBiling) => prevValue + item.code,\n                    0,\n                ),\n            };\n            await createBuyOrder(storeId, data);\n            message.success('Mua gói thành công');\n            await loadPackagesActive(false);\n            history.replace('/setting/billings/list');\n        } catch (error) {\n            message.error('Đã có lỗi xảy ra');\n        }\n    };\n\n    const genTransationCode = async () => {\n        try {\n            if (!storeId) return;\n            const transactionCode = await createTransactionCode(storeId, null);\n            setTransactionCode(transactionCode);\n        } catch (error) {\n            setTransactionCode();\n            message.error('Đã có lỗi xảy ra');\n        }\n    };\n\n    const setTransactionCode = (code: string = '') => {\n        dispatch({\n            type: types.SET_TRANSACTION_CODE,\n            payload: code,\n        });\n    };\n\n    const resetTransactionCode = () => setTransactionCode();\n\n    const closeWaringExperiedPackage = () => dispatch(hideWarningExperiedPackage());\n    const closeWaringExperiedTrail = () => dispatch(hideWarningExperiedTrial());\n\n    return {\n        ...state,\n        changeValueField,\n        initOrderState,\n        updatePackages,\n        changeCycleForPackage,\n        createPayment,\n        closeWaringExperiedPackage,\n        closeWaringExperiedTrail,\n        init,\n        loadPackagesActive,\n        genTransationCode,\n        resetTransactionCode,\n        resetListNeedExtend,\n    };\n};\n\nexport { ProviderBillingContext as default, useBilling };\n"]},"metadata":{},"sourceType":"module"}