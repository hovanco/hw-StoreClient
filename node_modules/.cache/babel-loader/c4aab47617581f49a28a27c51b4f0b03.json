{"ast":null,"code":"var _jsxFileName = \"/Users/mac3/Desktop/workspace/StoreClient/src/pages/product/product-new/index.tsx\",\n    _s = $RefreshSig$();\n\nimport { Col, Form, message, Row, Space, Typography } from 'antd';\nimport { useForm } from 'antd/lib/form/Form';\nimport { difference, every, get, isArray, isNil, map, omit, pick, set } from 'lodash';\nimport React, { useEffect, useState } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useHistory } from 'react-router-dom';\nimport productApi from '../../../api/product-api';\nimport { createStock } from '../../../api/stock-api';\nimport { uploadImagesRequest } from '../../../api/upload-api';\nimport { BackLink, InsaButton, PageTopWrapper } from '../../../components';\nimport { DefaultLayout } from '../../../layout';\nimport { storeAction } from '../../../reducers/storeState/action';\nimport theme from '../../../theme';\nimport { ProductFormDetail, ProductFormMedia } from '../components';\nimport ProductFormGeneral from './product-form-general';\nimport ProductFormProperties from './product-form-properties';\nimport ProductFormSaleInfo from '../components/product-form-sale-info';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\n;\nconst title = 'Thêm sản phẩm';\nconst requiredFields = ['name', 'sku', 'code', 'weight', 'originalPrice', 'wholesalePrice'];\n\nconst ProductForm = ({\n  product\n}) => {\n  _s();\n\n  const history = useHistory();\n  const dispatch = useDispatch();\n  const [form] = useForm();\n  const storeObj = useSelector(state => state.store.data);\n  const warehouses = useSelector(state => state.store.warehouses);\n  const attributes = useSelector(state => state.store.attributes);\n  const token = useSelector(state => state.auth.token);\n  const [loading, setLoading] = useState(false);\n  const [filesImage, setFilesImage] = useState([]);\n  const [quantityWarehouse, setQuantityWarehouse] = useState([]);\n  const [disabled, setDisabled] = useState(!product);\n  useEffect(() => {\n    if (storeObj._id) {\n      dispatch(storeAction.getCategoriesByStore(storeObj._id));\n      dispatch(storeAction.getAttributes(storeObj._id));\n    } // eslint-disable-next-line\n\n  }, [storeObj._id]);\n  useEffect(() => {\n    if (warehouses) {\n      const formatWarehouses = warehouses.map(warehouse => ({\n        storeId: warehouse.storeId,\n        warehouseId: warehouse._id,\n        quantity: 0,\n        productId: get(product, '_id')\n      }));\n      setQuantityWarehouse(formatWarehouses);\n    } // eslint-disable-next-line\n\n  }, [warehouses]);\n\n  const createNewProduct = async images => {\n    try {\n      const formData = await form.validateFields();\n      let formAttributes = form.getFieldValue('attributes');\n      const variantsParam = formData.variants ? formData.variants.map(item => ({ ...omit(item, ['name', 'length', 'width', 'height', 'weight', 'localId'])\n      })) : undefined;\n\n      if (formAttributes) {\n        formAttributes = map(formAttributes, item => pick(item, ['_id', 'name', 'tags']));\n\n        if (isArray(variantsParam) && variantsParam.length === 0) {\n          return message.error('Bạn chưa nhập phiên bản cho sản phẩm!');\n        }\n\n        const newAttributes = difference(formAttributes.map(i => i._id), attributes.data.map(i => i._id));\n\n        if (newAttributes.length) {\n          await Promise.all(newAttributes.map(attributeId => {\n            let attributeItem = formAttributes.filter(item => item._id === attributeId)[0];\n            return productApi.createAttribute(storeObj._id, attributeItem);\n          }));\n        }\n      }\n\n      set(formData, 'attributes', formAttributes);\n      const product = await productApi.createProduct(storeObj._id, { ...formData,\n        brandId: 'id__temp',\n        unitId: 'id__temp',\n        images,\n        originalPrice: Number(formData['originalPrice']),\n        wholesalePrice: Number(formData['wholesalePrice']),\n        price: Number(formData['wholesalePrice']),\n        variants: variantsParam\n      });\n      let stocks = form.getFieldValue('stocks');\n\n      if (stocks && stocks.length) {\n        stocks = stocks.filter(item => item.quantity);\n        await Promise.all(stocks.map(stock => {\n          let {\n            quantity,\n            productId,\n            warehouseId\n          } = stock;\n          return createStock({\n            storeId: storeObj._id,\n            warehouseId,\n            quantity,\n            productId: productId ? productId._id : product._id\n          });\n        }));\n      } else {\n        stocks = quantityWarehouse.filter(item => item.quantity);\n        await Promise.all(stocks.map(stock => {\n          let {\n            quantity,\n            _id\n          } = stock;\n          return createStock({\n            storeId: storeObj._id,\n            warehouseId: _id,\n            quantity,\n            productId: product._id\n          });\n        }));\n      }\n\n      setFilesImage([]);\n      setLoading(false);\n      message.success('Thêm sản phẩm thành công!');\n      history.push('/products/list');\n    } catch (error) {\n      if (get(error, 'response.status') === 409) {\n        message.error('Mã barcode đã tồn tại, vui lòng thử lại!');\n      } else {\n        message.error('Đã có lỗi xảy ra, vui lòng thử lại!');\n      }\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const uploadImages = new Promise(async (resolve, reject) => {\n    if (filesImage.length === 0) {\n      resolve([]);\n      return;\n    }\n\n    const accessToken = get(token, 'accessToken');\n    const files = filesImage.map(i => i.originFileObj);\n    uploadImagesRequest({\n      token: accessToken,\n      storeId: storeObj._id,\n      files\n    }).then(res => resolve(res)).catch(error => {\n      resolve([]);\n    });\n  });\n\n  const submit = () => {\n    setLoading(true);\n\n    if (storeObj._id) {\n      uploadImages.then(response => {\n        const images = response.map(item => item.key);\n        createNewProduct(images);\n      }).catch(error => {\n        createNewProduct([]);\n      });\n    } else {\n      setLoading(false);\n      message.error('Đã có lỗi xảy ra, vui lòng thử lại!');\n    }\n  };\n\n  const renderGroupBtn = () => {\n    return [/*#__PURE__*/_jsxDEV(InsaButton, {\n      style: {\n        width: 140\n      },\n      size: \"middle\",\n      disabled: loading,\n      onClick: () => history.push('/products/list'),\n      children: \"H\\u1EE7y\"\n    }, \"cancel\", false, {\n      fileName: _jsxFileName,\n      lineNumber: 213,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(InsaButton, {\n      size: \"middle\",\n      style: {\n        width: 140\n      },\n      type: \"primary\",\n      onClick: submit,\n      loading: loading,\n      disabled: disabled,\n      children: \"L\\u01B0u\"\n    }, \"save\", false, {\n      fileName: _jsxFileName,\n      lineNumber: 222,\n      columnNumber: 13\n    }, this) // TODO: Show after add feature\n    // <InsaButton\n    //     style={{ width: 140 }}\n    //     size=\"middle\"\n    //     key=\"help\"\n    //     disabled={loading}\n    //     icon={<QuestionCircleOutlined />}\n    // >\n    //     Trợ giúp\n    // </InsaButton>,\n    ];\n  };\n\n  const onFieldsChange = (changedFields, allFields) => {\n    const fields = allFields.filter(field => requiredFields.includes(field.name[0]));\n    const result = every(fields, field => {\n      var _field$errors;\n\n      return ((_field$errors = field.errors) === null || _field$errors === void 0 ? void 0 : _field$errors.length) === 0 && !isNil(field.value);\n    });\n    setDisabled(!result);\n  };\n\n  return /*#__PURE__*/_jsxDEV(DefaultLayout, {\n    title: title,\n    children: [/*#__PURE__*/_jsxDEV(PageTopWrapper, {\n      leftContent: /*#__PURE__*/_jsxDEV(_Fragment, {\n        children: [/*#__PURE__*/_jsxDEV(BackLink, {\n          to: \"/products/list\",\n          text: \" Danh s\\xE1ch s\\u1EA3n ph\\u1EA9m\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 261,\n          columnNumber: 25\n        }, this), /*#__PURE__*/_jsxDEV(Typography.Title, {\n          level: 3,\n          children: \"TH\\xCAM S\\u1EA2N PH\\u1EA8M\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 262,\n          columnNumber: 25\n        }, this)]\n      }, void 0, true),\n      rightContent: /*#__PURE__*/_jsxDEV(Space, {\n        children: renderGroupBtn()\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 265,\n        columnNumber: 31\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 258,\n      columnNumber: 13\n    }, this), /*#__PURE__*/_jsxDEV(Form, {\n      layout: \"vertical\",\n      className: \"product-form\",\n      size: \"small\",\n      form: form,\n      initialValues: product ? product : {},\n      onFieldsChange: onFieldsChange,\n      children: [/*#__PURE__*/_jsxDEV(Row, {\n        gutter: [16, 0],\n        style: {\n          paddingLeft: theme.spacing.m,\n          paddingRight: theme.spacing.m,\n          marginTop: 28\n        },\n        children: [/*#__PURE__*/_jsxDEV(Col, {\n          span: 16,\n          children: [/*#__PURE__*/_jsxDEV(ProductFormGeneral, {\n            form: form\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 285,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(ProductFormSaleInfo, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 286,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(ProductFormProperties, {\n            form: form,\n            quantity: quantityWarehouse,\n            setQuantity: setQuantityWarehouse\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 287,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 284,\n          columnNumber: 21\n        }, this), /*#__PURE__*/_jsxDEV(Col, {\n          span: 8,\n          children: [/*#__PURE__*/_jsxDEV(ProductFormMedia, {\n            setFilesImage: setFilesImage\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 294,\n            columnNumber: 25\n          }, this), /*#__PURE__*/_jsxDEV(ProductFormDetail, {\n            form: form\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 295,\n            columnNumber: 25\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 293,\n          columnNumber: 21\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 276,\n        columnNumber: 17\n      }, this), /*#__PURE__*/_jsxDEV(Row, {\n        justify: \"end\",\n        style: {\n          marginTop: 32,\n          paddingRight: theme.spacing.m,\n          paddingBottom: 72\n        },\n        children: /*#__PURE__*/_jsxDEV(Space, {\n          children: renderGroupBtn()\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 307,\n          columnNumber: 21\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 299,\n        columnNumber: 17\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 268,\n      columnNumber: 13\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 257,\n    columnNumber: 9\n  }, this);\n};\n\n_s(ProductForm, \"JzIsmibnH/DFMWVYZc40aMsBrkU=\", false, function () {\n  return [useHistory, useDispatch, useForm, useSelector, useSelector, useSelector, useSelector];\n});\n\n_c = ProductForm;\nexport default ProductForm;\n\nvar _c;\n\n$RefreshReg$(_c, \"ProductForm\");","map":{"version":3,"sources":["/Users/mac3/Desktop/workspace/StoreClient/src/pages/product/product-new/index.tsx"],"names":["Col","Form","message","Row","Space","Typography","useForm","difference","every","get","isArray","isNil","map","omit","pick","set","React","useEffect","useState","useDispatch","useSelector","useHistory","productApi","createStock","uploadImagesRequest","BackLink","InsaButton","PageTopWrapper","DefaultLayout","storeAction","theme","ProductFormDetail","ProductFormMedia","ProductFormGeneral","ProductFormProperties","ProductFormSaleInfo","title","requiredFields","ProductForm","product","history","dispatch","form","storeObj","state","store","data","warehouses","attributes","token","auth","loading","setLoading","filesImage","setFilesImage","quantityWarehouse","setQuantityWarehouse","disabled","setDisabled","_id","getCategoriesByStore","getAttributes","formatWarehouses","warehouse","storeId","warehouseId","quantity","productId","createNewProduct","images","formData","validateFields","formAttributes","getFieldValue","variantsParam","variants","item","undefined","length","error","newAttributes","i","Promise","all","attributeId","attributeItem","filter","createAttribute","createProduct","brandId","unitId","originalPrice","Number","wholesalePrice","price","stocks","stock","success","push","uploadImages","resolve","reject","accessToken","files","originFileObj","then","res","catch","submit","response","key","renderGroupBtn","width","onFieldsChange","changedFields","allFields","fields","field","includes","name","result","errors","value","paddingLeft","spacing","m","paddingRight","marginTop","paddingBottom"],"mappings":"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","sourcesContent":["import { Col, Form, message, Row, Space, Typography } from 'antd';\nimport { useForm } from 'antd/lib/form/Form';\nimport { difference, every, get, isArray, isNil, map, omit, pick, set } from 'lodash';\nimport React, { FC, useEffect, useState } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { useHistory } from 'react-router-dom';\nimport productApi from '../../../api/product-api';\nimport { createStock } from '../../../api/stock-api';\nimport { uploadImagesRequest } from '../../../api/upload-api';\nimport { BackLink, InsaButton, PageTopWrapper } from '../../../components';\nimport { DefaultLayout } from '../../../layout';\nimport { IProduct, IStock, IWarehouse } from '../../../models';\nimport { storeAction } from '../../../reducers/storeState/action';\nimport { IState } from '../../../store/rootReducer';\nimport theme from '../../../theme';\nimport { ProductFormDetail, ProductFormMedia } from '../components';\nimport ProductFormGeneral from './product-form-general';\nimport ProductFormProperties from './product-form-properties';\nimport { IStockUpdate } from './product-form-properties/update-quantity-product';\nimport ProductFormSaleInfo from '../components/product-form-sale-info';\n\ninterface FieldData {\n    name: string | number | (string | number)[];\n    value?: any;\n    touched?: boolean;\n    validating?: boolean;\n    errors?: string[];\n}\n\ninterface Props {\n    product?: IProduct;\n};\n\nconst title = 'Thêm sản phẩm';\nconst requiredFields = ['name', 'sku', 'code', 'weight', 'originalPrice', 'wholesalePrice'];\n\nconst ProductForm: FC<Props> = ({ product }) => {\n    const history = useHistory();\n    const dispatch = useDispatch();\n    const [form] = useForm();\n\n    const storeObj = useSelector((state: IState) => state.store.data);\n    const warehouses = useSelector((state: IState) => state.store.warehouses);\n    const attributes = useSelector((state: IState) => state.store.attributes);\n    const token = useSelector((state: IState) => state.auth.token);\n\n    const [loading, setLoading] = useState<boolean>(false);\n    const [filesImage, setFilesImage] = useState<any[]>([]);\n    const [quantityWarehouse, setQuantityWarehouse] = useState<IStockUpdate[]>([]);\n    const [disabled, setDisabled] = useState<boolean>(!product);\n\n    useEffect(() => {\n        if (storeObj._id) {\n            dispatch(storeAction.getCategoriesByStore(storeObj._id));\n            dispatch(storeAction.getAttributes(storeObj._id));\n        }\n        // eslint-disable-next-line\n    }, [storeObj._id]);\n\n    useEffect(() => {\n        if (warehouses) {\n            const formatWarehouses: IStockUpdate[] = warehouses.map((warehouse: IWarehouse) => ({\n                storeId: warehouse.storeId as string,\n                warehouseId: warehouse._id,\n                quantity: 0,\n                productId: get(product, '_id'),\n            }));\n\n            setQuantityWarehouse(formatWarehouses);\n        }\n        // eslint-disable-next-line\n    }, [warehouses]);\n\n    const createNewProduct = async (images: string[]) => {\n        try {\n            const formData = await form.validateFields();\n            let formAttributes = form.getFieldValue('attributes');\n            const variantsParam = formData.variants\n                ? formData.variants.map((item: any) => ({\n                    ...omit(item, ['name', 'length', 'width', 'height', 'weight', 'localId']),\n                }))\n                : undefined;\n\n            if (formAttributes) {\n                formAttributes = map(formAttributes, (item: any) =>\n                    pick(item, ['_id', 'name', 'tags'])\n                );\n\n                if (isArray(variantsParam) && variantsParam.length === 0) {\n                    return message.error('Bạn chưa nhập phiên bản cho sản phẩm!');\n                }\n                const newAttributes = difference(\n                    formAttributes.map((i: any) => i._id),\n                    attributes.data.map((i: any) => i._id)\n                );\n\n                if (newAttributes.length) {\n                    await Promise.all(\n                        newAttributes.map((attributeId: string) => {\n                            let attributeItem = formAttributes.filter(\n                                (item: any) => item._id === attributeId\n                            )[0];\n                            return productApi.createAttribute(\n                                storeObj._id as string,\n                                attributeItem\n                            );\n                        })\n                    );\n                }\n            }\n\n            set(formData, 'attributes', formAttributes);\n\n            const product = await productApi.createProduct(storeObj._id as string, {\n                ...formData,\n                brandId: 'id__temp',\n                unitId: 'id__temp',\n                images,\n                originalPrice: Number(formData['originalPrice']),\n                wholesalePrice: Number(formData['wholesalePrice']),\n                price: Number(formData['wholesalePrice']),\n                variants: variantsParam,\n            });\n\n            let stocks = form.getFieldValue('stocks');\n\n            if (stocks && stocks.length) {\n                stocks = stocks.filter((item: IStock) => item.quantity);\n\n                await Promise.all(\n                    stocks.map((stock: IStock) => {\n                        let { quantity, productId, warehouseId } = stock;\n\n                        return createStock({\n                            storeId: storeObj._id as string,\n                            warehouseId,\n                            quantity,\n                            productId: productId\n                                ? (productId._id as string)\n                                : (product._id as string),\n                        });\n                    })\n                );\n            } else {\n                stocks = quantityWarehouse.filter((item) => item.quantity);\n                await Promise.all(\n                    stocks.map((stock: IStock) => {\n                        let { quantity, _id } = stock;\n                        return createStock({\n                            storeId: storeObj._id as string,\n                            warehouseId: _id,\n                            quantity,\n                            productId: product._id as string,\n                        });\n                    })\n                );\n            }\n\n            setFilesImage([]);\n            setLoading(false);\n            message.success('Thêm sản phẩm thành công!');\n            history.push('/products/list');\n        } catch (error) {\n            if (get(error, 'response.status') === 409) {\n                message.error('Mã barcode đã tồn tại, vui lòng thử lại!');\n            } else {\n                message.error('Đã có lỗi xảy ra, vui lòng thử lại!');\n            }\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    const uploadImages = new Promise(async (resolve, reject) => {\n        if (filesImage.length === 0) {\n            resolve([]);\n            return;\n        }\n\n        const accessToken = get(token, 'accessToken');\n        const files = filesImage.map((i: any) => i.originFileObj);\n\n        uploadImagesRequest({\n            token: accessToken,\n            storeId: storeObj._id as string,\n            files,\n        })\n            .then((res) => resolve(res))\n            .catch((error) => {\n                resolve([]);\n            });\n    });\n\n    const submit = () => {\n        setLoading(true);\n        if (storeObj._id) {\n            uploadImages\n                .then((response) => {\n                    const images = (response as any[]).map((item: any) => item.key);\n                    createNewProduct(images);\n                })\n                .catch((error) => {\n                    createNewProduct([]);\n                });\n        } else {\n            setLoading(false);\n            message.error('Đã có lỗi xảy ra, vui lòng thử lại!');\n        }\n    };\n\n    const renderGroupBtn = () => {\n        return [\n            <InsaButton\n                style={{ width: 140 }}\n                size=\"middle\"\n                key=\"cancel\"\n                disabled={loading}\n                onClick={() => history.push('/products/list')}\n            >\n                Hủy\n            </InsaButton>,\n            <InsaButton\n                size=\"middle\"\n                style={{ width: 140 }}\n                type=\"primary\"\n                key=\"save\"\n                onClick={submit}\n                loading={loading}\n                disabled={disabled}\n            >\n                Lưu\n            </InsaButton>,\n            // TODO: Show after add feature\n            // <InsaButton\n            //     style={{ width: 140 }}\n            //     size=\"middle\"\n            //     key=\"help\"\n            //     disabled={loading}\n            //     icon={<QuestionCircleOutlined />}\n            // >\n            //     Trợ giúp\n            // </InsaButton>,\n        ];\n    };\n\n    const onFieldsChange = (changedFields: FieldData[], allFields: FieldData[]) => {\n        const fields = allFields.filter((field: FieldData) =>\n            requiredFields.includes((field.name as string[])[0]));\n\n        const result = every(fields, (field: FieldData) =>\n            field.errors?.length === 0 && !isNil(field.value));\n\n        setDisabled(!result);\n    }\n\n    return (\n        <DefaultLayout title={title}>\n            <PageTopWrapper\n                leftContent={\n                    <>\n                        <BackLink to=\"/products/list\" text=\" Danh sách sản phẩm\" />\n                        <Typography.Title level={3}>THÊM SẢN PHẨM</Typography.Title>\n                    </>\n                }\n                rightContent={<Space>{renderGroupBtn()}</Space>}\n            />\n\n            <Form\n                layout=\"vertical\"\n                className=\"product-form\"\n                size=\"small\"\n                form={form}\n                initialValues={product ? product : {}}\n                onFieldsChange={onFieldsChange}\n            >\n                <Row\n                    gutter={[16, 0]}\n                    style={{\n                        paddingLeft: theme.spacing.m,\n                        paddingRight: theme.spacing.m,\n                        marginTop: 28,\n                    }}\n                >\n                    <Col span={16}>\n                        <ProductFormGeneral form={form} />\n                        <ProductFormSaleInfo />\n                        <ProductFormProperties\n                            form={form}\n                            quantity={quantityWarehouse}\n                            setQuantity={setQuantityWarehouse}\n                        />\n                    </Col>\n                    <Col span={8}>\n                        <ProductFormMedia setFilesImage={setFilesImage} />\n                        <ProductFormDetail form={form} />\n                    </Col>\n                </Row>\n\n                <Row\n                    justify=\"end\"\n                    style={{\n                        marginTop: 32,\n                        paddingRight: theme.spacing.m,\n                        paddingBottom: 72,\n                    }}\n                >\n                    <Space>{renderGroupBtn()}</Space>\n                </Row>\n            </Form>\n        </DefaultLayout>\n    );\n};\n\nexport default ProductForm;\n"]},"metadata":{},"sourceType":"module"}